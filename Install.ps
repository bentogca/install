# ====================================================================
# SCRIPT DE AUTO INSTALAÇÃO, SEM CONFIGURAÇÃO DE REDE
# --------------------------------------------------------------------
# DEVE SER EXECUTADO COMO ADMINISTRADOR!
# O script irá nomear a máquina, mapear o drive F:, copiar os arquivos, 
# juntar ao AD e REINICIAR.
# A CONFIGURAÇÃO DE IP (SEÇÃO 2) FOI REMOVIDA.
# ====================================================================

# --------------------------------------------------------------------
# --- CONFIGURAÇÕES FIXAS DA INFRAESTRUTURA ---
# --------------------------------------------------------------------
# Configuração do Mapeamento F:
$NetworkSourceServer = "172.16.2.73"
$NetworkShareName = "Conexo"
$NetworkSourcePath = "\func\TI\TI-Carlos\apps"
$MAPPED_DRIVE_LETTER = "F"
$FullUNCPathToShare = "\\$NetworkSourceServer\$NetworkShareName"
# Uso de operador '+' (concatenação) para evitar erro de análise de drive.
$NetworkSource = $MAPPED_DRIVE_LETTER + ":\" + $NetworkSourcePath

# Configuração de Rede e AD (Variáveis mantidas para o Domain Join)
$IP_Address = "172.16.0.95" # Não será aplicado na interface
$Subnet_Mask_CIDR = 24
$Gateway = "172.16.0.254"
$Domain_Name = "atacado.local"
$AD_Server_IP = "172.16.2.85" 

# --- VARIÁVEIS DE DESTINO ---
$DestERP = "C:\erp"
$DestRetaguarda = "C:\retaguarda"
# Copia para a área de trabalho PÚBLICA (acessível por todos os usuários do domínio)
$DestApps = "C:\Users\Public\Desktop\apps" 

# ----------------------------------------------------
# 1. COLETAR INFORMAÇÕES DO USUÁRIO
# ----------------------------------------------------
Write-Host "============================================="
Write-Host "  ASSISTENTE DE CONFIGURAÇÃO - INÍCIO"
Write-Host "============================================="

$ComputerName = Read-Host "Digite o NOME DE USUÁRIO (p. ex: joao.silva) para nomear a máquina"
if ([string]::IsNullOrWhiteSpace($ComputerName)) {
    Write-Error "Nome de usuário não pode ser vazio."
    exit 1
}
$NewComputerName = "PC-" + $ComputerName.ToUpper().Replace('.', '-')
Write-Host "Novo nome da máquina será: $NewComputerName"

Write-Host "`n>> CREDENCIAIS DO AD <<"
Write-Host "Insira as credenciais de um usuário com permissão para juntar ao domínio $Domain_Name."
$ADUser = Read-Host "Usuário (p. ex: admin_ad)"
$ADPassword = Read-Host -AsSecureString "Senha"
$ADCredential = New-Object System.Management.Automation.PSCredential($ADUser, $ADPassword)

# ====================================================
# SEÇÃO 2 (CONFIGURAÇÃO DE REDE) FOI REMOVIDA.
# O script assume que a rede j?? est?? funcional.
# ====================================================

# ----------------------------------------------------
# 3. MAPEAMENTO DO DRIVE F:
# ----------------------------------------------------
Write-Host "`n--- 3. MAPEANDO DRIVE $MAPPED_DRIVE_LETTER ---"

try {
    # Remove qualquer mapeamento F: existente
    (New-Object -ComObject WScript.Network).RemoveNetworkDrive($MAPPED_DRIVE_LETTER, $true, $true) | Out-Null
    
    # Mapeia o drive F:
    (New-Object -ComObject WScript.Network).MapNetworkDrive($MAPPED_DRIVE_LETTER, $FullUNCPathToShare)
    # Concatenação segura para exibir a letra do drive
    Write-Host "Drive " + $MAPPED_DRIVE_LETTER + ": mapeado para $FullUNCPathToShare com sucesso." 

} catch {
    Write-Error "ERRO: Falha ao mapear o drive $MAPPED_DRIVE_LETTER. O script ir?? tentar acessar o caminho mesmo assim."
}

# ----------------------------------------------------
# 4. CÓPIA DOS ARQUIVOS DE INSTALAÇÃO (DO DRIVE F:)
# ----------------------------------------------------
Write-Host "`n--- 4. COPIANDO ARQUIVOS DE INSTALAÇÃO DE $NetworkSource ---"

try {
    # 4a. Cria diretórios de destino
    New-Item -Path $DestERP, $DestRetaguarda, $DestApps -ItemType Directory -Force | Out-Null
    
    # 4b. Copia Pastas Específicas para C:\ (ERP e RETAGUARDA)
    Write-Host "Copiando ERP e RETAGUARDA..."
    Copy-Item -Path "$NetworkSource\erp" -Destination $DestERP -Recurse -Force -ErrorAction Stop
    Copy-Item -Path "$NetworkSource\retaguarda" -Destination $DestRetaguarda -Recurse -Force -ErrorAction Stop

    # 4c. Copia o Resto (arquivos e outras pastas) para Public\Desktop\apps
    Write-Host "Copiando demais arquivos/pastas para Área de Trabalho Pública..."
    
    # Filtra tudo exceto 'erp' e 'retaguarda'
    Get-ChildItem -Path $NetworkSource -Exclude "erp", "retaguarda" | ForEach-Object {
        Copy-Item -Path $_.FullName -Destination $DestApps -Recurse -Force -ErrorAction Stop
    }

    Write-Host "Cópia de arquivos concluída. Programas prontos para o novo usuário de domínio."
} catch {
    Write-Error "ERRO FATAL: Falha ao acessar ou copiar arquivos de $NetworkSource. O script não pode continuar."
    exit 1
}

# ----------------------------------------------------
# 5. JUNÇÃO AO DOMÍNIO E REINICIALIZAÇÃO
# ----------------------------------------------------
Write-Host "`n--- 5. JUNÇÃO AO DOMÍNIO E REINICIALIZAÇÃO ---"

try {
    # Tenta juntar ao domínio e alterar o nome. O -Restart garante a aplicação e o encerramento do script.
    Add-Computer -DomainName $Domain_Name -NewName $NewComputerName -Credential $ADCredential -Restart
    
    Write-Host "Comando de junção ao domínio $Domain_Name enviado. A máquina será reiniciada em breve."
    
} catch {
    Write-Error "ERRO FATAL: Falha ao ingressar no domínio. Verifique as credenciais ou a conectividade com o DNS $AD_Server_IP."
    Write-Host "O script terminou, mas a máquina não ingressou no domínio."
    exit 1
}

# FIM DO SCRIPT
